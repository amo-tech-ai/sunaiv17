
# Sun AI Agency â€” Frontendâ€“Backend Wiring Audit & Implementation Plan

**Date:** January 8, 2025
**Status:** Pre-Production Audit
**Auditor:** Senior System Architect
**Context:** Transitioning from "Thick Client" Prototype to "Connected SaaS".

---

## 1. Progress Tracker: Screen Completion Matrix

This matrix tracks the wiring status of each screen: **UI** (Visuals), **Logic** (State), **AI** (Edge Functions), and **Data** (Database Persistence).

| Screen | Completion | UI Status | AI Wiring | Data Persistence | Notes |
| :--- | :---: | :---: | :---: | :---: | :--- |
| **WIZARD** | | | | | |
| **Step 1: Context** | **90%** | âœ… Ready | âœ… Edge (`analyst`) | âŒ LocalStorage | Analysis runs on server, but results save to browser. |
| **Step 2: Diagnostics** | **90%** | âœ… Ready | âœ… Edge (`extractor`) | âŒ LocalStorage | Questions generated by AI, not saved to DB. |
| **Step 3: Systems** | **90%** | âœ… Ready | âœ… Edge (`optimizer`) | âŒ LocalStorage | Recommendations valid, selection local only. |
| **Step 4: Readiness** | **90%** | âœ… Ready | âœ… Edge (`scorer`) | âŒ LocalStorage | Score calc is accurate (Code Exec), storage is local. |
| **Step 5: Roadmap** | **85%** | âœ… Ready | âœ… Edge (`planner`) | âŒ LocalStorage | Roadmap generation works (Thinking), output local. |
| **DASHBOARD** | | | | | |
| **Overview** | **60%** | âœ… Ready | âš ï¸ Static | âŒ LocalStorage | Reads from local Wizard state. Needs DB query. |
| **CRM** | **80%** | âœ… Ready | âœ… Edge (`crm-intel`) | âœ… Supabase DB | **Connected.** Reads `crm_contacts`. |
| **Projects** | **40%** | âœ… Ready | âš ï¸ Static | âŒ Mocks | Uses `MOCK_PROJECTS` in hook. |
| **Analytics** | **40%** | âœ… Ready | âš ï¸ Static | âŒ Mocks | Uses `MOCK_ANALYTICS` in hook. |
| **Tasks** | **50%** | âœ… Ready | âš ï¸ Static | âŒ LocalStorage | Tasks generated from local roadmap. |
| **Systems** | **50%** | âœ… Ready | âš ï¸ Static | âŒ LocalStorage | Shows local selections. |

**Overall System Health:**
*   **Frontend/AI Bridge:** ðŸŸ¢ **Healthy** (All AI calls proxied via Edge Functions).
*   **Frontend/DB Bridge:** ðŸ”´ **Critical** (Most state remains in LocalStorage).

---

## 2. System Wiring Overview

### Current Data Flow (As-Is)
```mermaid
graph LR
    User -->|Input| React_State
    React_State -->|Persist| LocalStorage[(Browser Storage)]
    
    React_State -->|Invoke| Edge_Functions
    Edge_Functions -->|Prompt| Gemini_AI
    Gemini_AI -->|Response| Edge_Functions
    Edge_Functions -->|JSON| React_State
    
    subgraph "Isolated System"
        CRM_Tab -->|Read/Write| Supabase_DB[(PostgreSQL)]
    end
```

### Target Data Flow (To-Be)
```mermaid
graph LR
    User -->|Input| React_State
    React_State -->|Sync| Supabase_DB[(PostgreSQL)]
    
    React_State -->|Invoke| Edge_Functions
    Edge_Functions -->|Context| Supabase_DB
    Edge_Functions -->|Prompt| Gemini_AI
    Gemini_AI -->|Response| Edge_Functions
    Edge_Functions -->|Store| Supabase_DB
```

---

## 3. Detailed Wiring Audit

### A. Wizard Wiring (The Input Engine)

**Status:** The "Brain" is connected, but the "Memory" is temporary.

*   **Step 1 (Analyst):**
    *   **Wiring:** `Step1Context.tsx` -> `analyst.ts` -> `supabase.functions.invoke('analyst')`.
    *   **Security:** âœ… API Key hidden in Edge Function.
    *   **Gap:** User inputs (`businessName`, `website`) are not saved to `projects` table until wizard completion (risky).
*   **Step 2 (Extractor):**
    *   **Wiring:** `Step2Diagnostics.tsx` -> `extractor.ts` -> `supabase.functions.invoke('extractor')`.
    *   **Logic:** Uses `IndustryPack` correctly on server.
    *   **Gap:** Diagnostic answers aren't saved to DB.
*   **Step 5 (Planner):**
    *   **Wiring:** `Step5Plan.tsx` -> `planner.ts` -> `supabase.functions.invoke('planner')`.
    *   **Gap:** The expensive/complex Roadmap JSON is lost if the tab closes.

### B. Dashboard Wiring (The Execution Engine)

**Status:** A mix of Real and Fake data.

*   **CRM Tab:**
    *   **Wiring:** `useCRM.ts` calls `supabase.from('crm_contacts')`.
    *   **Status:** âœ… **Production Ready**. Renders real rows.
*   **Projects Tab:**
    *   **Wiring:** `useProjects.ts` returns `MOCK_PROJECTS`.
    *   **Status:** ðŸ”´ **Mocked**. Needs connection to `projects` and `tasks` tables.
*   **Analytics Tab:**
    *   **Wiring:** `useAnalytics.ts` returns `MOCK_ANALYTICS`.
    *   **Status:** ðŸ”´ **Mocked**. Needs aggregation queries on `invoices` table.

---

## 4. Backend / Edge Function Audit

All functions reside in `supabase/functions/`.

| Function | Input Validation | AI Model | Response Schema | Audit Verdict |
| :--- | :--- | :--- | :--- | :--- |
| `analyst` | âœ… Typed | Flash | Stream + JSON | **PASS** |
| `extractor` | âœ… Typed | Pro | `DiagnosticSchema` | **PASS** |
| `optimizer` | âœ… Typed | Flash | `RecommendationSchema` | **PASS** |
| `scorer` | âœ… Typed | Flash | `RiskAnalysisSchema` | **PASS** |
| `planner` | âœ… Typed | Pro | `RoadmapSchema` | **PASS** |
| `crm-intel`| âœ… Typed | Flash | `HealthSchema` | **PASS** |

**Observation:** The Edge Function layer is the strongest part of the stack. It strictly adheres to `gemini-3` standards with proper schemas and security.

---

## 5. Required Actions (Implementation Plan)

To reach **Production Readiness**, execute these wiring tasks:

### Phase 1: Persistence (The "Memory" Upgrade)
1.  **Update `useWizardState.ts`:**
    *   Replace `localStorage` with `supabase.from('wizard_sessions')`.
    *   On step change, `upsert` the current state to the DB.
2.  **Connect Dashboard Hooks:**
    *   Refactor `useProjects.ts` to fetch from `projects` table.
    *   Refactor `useAnalytics.ts` to fetch from `invoices` table.

### Phase 2: Authentication
1.  **Auth Guard:**
    *   Wrap `Dashboard.tsx` in a `RequireAuth` component.
    *   If no session, redirect to `LandingPage` (needs creation) or Login.

### Phase 3: Data Hydration
1.  **Roadmap Persistence:**
    *   When Step 5 Planner returns JSON, write it immediately to `roadmaps` table.
    *   Dashboard `RoadmapView` should read from `roadmaps` table, not `localStorage`.

---

## 6. GO / NO-GO Decision

**Verdict:** ðŸ”´ **NO-GO for Public Launch**

**Reasoning:**
1.  **Data Loss Risk:** Relying on `localStorage` for a complex 5-step wizard is unsafe. Users will lose progress.
2.  **Mock Data:** Dashboard Tabs (Projects, Analytics) are visual shells showing fake data.
3.  **Security:** While AI keys are safe, user data is not isolated (RLS policies rely on Auth, but Auth flow isn't enforced in Wizard).

**Path to Green:**
Complete **Phase 1 (Persistence)** and **Phase 2 (Auth)**. Estimated effort: 3-4 days.
